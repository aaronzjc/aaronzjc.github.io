---
layout: post
title: "HTTPS协议"
date:   2019-11-30 10:00:00 +0800
categories: web
---
## 前言

做Web开发，基本都知道`HTTPS`协议，443接口，非对称加密。打交道挺多的，每次部署网站的时候，都要维护一套证书。但是鉴于自己的惰性，一直没有怎么很深入去研究这个东西。最近因为想抓包学习`HTTP2`协议，然后发现现有的`HTTP2`方案强制绑定了`HTTPS`。于是决定从头开始深入学习一遍，弥补之前的技术债。

## 概述

`HTTPS`协议全称是`HTTP over TLS`。这句话表明了`HTTPS`并不是一个全新的协议，他是`HTTP`协议和`TLS`协议结合的产物。

`HTTP`协议是明文传输，没有任何安全机制。这意味着，中间人可以监听两者通信，获取通信内容；没办法验证通信双方身份，中间人能够篡改接收到的流量，而双方没有感知。这对于日益复杂的Web环境，是无法接受的。因此，`HTTPS`应运而生，并且迅速的普及。现在非`HTTPS`站点，Chrome会打上不安全的标签。

`HTTPS`有两个流程。首先走`TLS`协议验证服务器身份，验证成功后获取下一步的加密密钥；之后则是走`HTTP`协议，利用上一步的密钥加密数据，进行通信。

1. `HTTPS`通信加密方式

加密方式有对称加密和非对称加密。对称加密是加密和解密用的是同一个密钥；非对称加密是加密和解密用的不同密钥。TCP/IP网络是不可靠的，所以对称加密是不安全的。但是，非对称加密比较耗费CPU计算能力。所以`HTTPS`协议只在第一阶段时，用到了非对称加密。在后续的通信，使用的是对称加密方式。对称加密涉及到加密密钥，那怎么保证密钥传输的过程中，不被拦截？答案是使用非对称加密传输密钥。这里明白了服务器需要一对公私钥来用于密钥传输。

2. 如何验证服务器是可信的

依然记住，TCP/IP网络是不可靠的，接收到的所有信息都是可能经过篡改的。在一个不可靠的网络中，怎么确保对方是那个人。答案是，证明不了，只能找别人来证明。因此，`HTTPS`服务器需要找权威的CA(certificate agent, 颁发证书的机构)机构证明自己。CA验证服务器真实后，用服务器的公钥颁发一个证书。客户端拿到服务器的证书后，通过一些方式验证证书有效，验证成功后，就到了服务器的公钥，且确定了通信的对象是可靠的。

如果描述的算清晰的话，到这里就应该能理解部署一个`HTTPS`网站需要的东西了。首先是一对公私钥，用于密钥传输；其次是一个权威机构颁发的数字证书，证明服务器和域名真实可靠。通常公钥是集成在数字证书中的。所以，部署只需要两个文件，一个私钥，一个证书。

总结一下就是，服务器生成一对公私钥。然后用公钥去CA机构生成一个数字证书。部署时，配置证书和私钥。客户端请求服务器拿到证书信息，然后验证证书有效性。验证通过后，拿到了服务器的公钥。接着，客户端生成随机数，通过公钥加密，传给服务器。服务器用私钥解密，得到客户端的随机数。服务器根据算法，生成加密密钥。客户端也可以根据相同的算法，得到密钥。之后，就是利用密钥加密数据进行`HTTP`通信了。

## 通信细节

### TLS协议

### 证书认证

### 密钥生成算法